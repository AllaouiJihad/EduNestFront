<!-- src/app/features/schools/school-comparison/school-comparison.component.html -->
<app-navbar></app-navbar>

<div class="comparison-page">
  <div class="container">
    <div class="page-header">
      <h1>Comparer des √©coles</h1>
      <p class="subtitle">Comparez jusqu'√† {{ maxSchoolsToCompare }} √©coles pour faire le meilleur choix</p>
    </div>

    <div *ngIf="loading" class="loading-container">
      <app-loading-spinner></app-loading-spinner>
      <p>Chargement des donn√©es de comparaison...</p>
    </div>

    <app-error-alert *ngIf="error" [message]="error"></app-error-alert>

    <div class="comparison-container">
      <!-- S√©lection des √©coles -->
      <div class="selection-section">
        <h2>√âcoles s√©lectionn√©es ({{ selectedSchools.length }}/{{ maxSchoolsToCompare }})</h2>

        <div class="schools-selection">
          <div *ngFor="let school of selectedSchools" class="selected-school">
            <div class="school-info">
              <h3>{{ school.name }}</h3>
              <p class="school-location">{{ school.city }} {{ school.postalCode ? '(' + school.postalCode + ')' : '' }}</p>
              <div class="school-rating">
                <app-star-rating [rating]="school.averageRating"></app-star-rating>
                <span>{{ school.averageRating | number:'1.1-1' }}</span>
              </div>
            </div>
            <button
              class="remove-btn"
              (click)="removeSchoolFromComparison(school.id)"
              [attr.aria-label]="'Retirer ' + school.name + ' de la comparaison'"
            >
              ‚úï
            </button>
          </div>

          <div *ngIf="selectedSchools.length < maxSchoolsToCompare" class="add-school-placeholder">
            <p>Ajouter une √©cole</p>
            <form [formGroup]="searchForm" (ngSubmit)="searchSchools()" class="search-form">
              <div class="search-field">
                <input
                  type="text"
                  formControlName="searchQuery"
                  placeholder="Rechercher une √©cole..."
                >
                <button
                  type="submit"
                  class="search-btn"
                  [disabled]="searchForm.invalid || searchLoading"
                >
                  <span *ngIf="!searchLoading">üîç</span>
                  <app-loading-spinner *ngIf="searchLoading"></app-loading-spinner>
                </button>
              </div>
            </form>

            <div *ngIf="searchResults.length > 0" class="search-results">
              <div
                *ngFor="let school of searchResults"
                class="search-result-item"
                (click)="addSchoolToComparison(school)"
                [class.disabled]="isSchoolSelected(school.id)"
              >
                <div class="search-school-info">
                  <h4>{{ school.name }}</h4>
                  <p>{{ school.city }}</p>
                </div>
                <span *ngIf="isSchoolSelected(school.id)" class="already-selected">S√©lectionn√©e</span>
                <span *ngIf="!isSchoolSelected(school.id)" class="add-icon">+</span>
              </div>
            </div>
          </div>
        </div>

        <div *ngIf="selectedSchools.length < 2" class="selection-help">
          <p>S√©lectionnez au moins 2 √©coles pour les comparer</p>

          <div *ngIf="schools.length > 0" class="popular-schools">
            <h3>√âcoles populaires</h3>
            <div class="schools-grid">
              <div
                *ngFor="let school of schools.slice(0, 6)"
                class="popular-school-card"
                (click)="addSchoolToComparison(school)"
                [class.disabled]="isSchoolSelected(school.id)"
              >
                <h4>{{ school.name }}</h4>
                <p>{{ school.city }}</p>
                <div class="school-rating">
                  <app-star-rating [rating]="school.averageRating"></app-star-rating>
                  <span>{{ school.averageRating | number:'1.1-1' }}</span>
                </div>
                <span *ngIf="isSchoolSelected(school.id)" class="already-selected">S√©lectionn√©e</span>
              </div>
            </div>
          </div>
        </div>

        <div *ngIf="selectedSchools.length >= 2" class="comparison-actions">
          <button class="share-btn" (click)="copyShareLink()">
            Partager cette comparaison
          </button>
          <button class="reset-btn" (click)="resetComparison()">
            R√©initialiser
          </button>
        </div>
      </div>

      <!-- Tableau de comparaison -->
      <div *ngIf="comparisonData && selectedSchools.length >= 2" class="comparison-results">
        <h2>Tableau comparatif</h2>

        <div class="comparison-table-container">
          <table class="comparison-table">
            <thead>
            <tr>
              <th class="criterion-header">Crit√®re</th>
              <th *ngFor="let school of selectedSchools">
                {{ school.name }}
              </th>
            </tr>
            </thead>
            <tbody>
            <!-- Informations g√©n√©rales -->
            <tr class="category-row">
              <td [attr.colspan]="selectedSchools.length + 1">Informations g√©n√©rales</td>
            </tr>
            <tr>
              <td class="criterion-name">Localisation</td>
              <td *ngFor="let school of selectedSchools">
                {{ school.city }} {{ school.postalCode ? '(' + school.postalCode + ')' : '' }}
              </td>
            </tr>
            <tr>
              <td class="criterion-name">Cat√©gorie</td>
              <td *ngFor="let school of selectedSchools">
                {{ school.categoryName || 'Non sp√©cifi√©' }}
              </td>
            </tr>
            <tr>
              <td class="criterion-name">Note moyenne</td>
              <td *ngFor="let school of selectedSchools">
                <div class="rating-display">
                  <app-star-rating [rating]="school.averageRating"></app-star-rating>
                  <span>{{ school.averageRating | number:'1.1-1' }}</span>
                </div>
              </td>
            </tr>
            <tr>
              <td class="criterion-name">Nombre d'avis</td>
              <td *ngFor="let school of selectedSchools">
                {{ school.reviewCount }}
              </td>
            </tr>

            <!-- Cat√©gories de comparaison -->
            <ng-container *ngIf="comparisonData && comparisonData.comparisonMatrix">
              <ng-container *ngFor="let category of getMatrixCategories()">
                <tr class="category-row">
                  <td [attr.colspan]="selectedSchools.length + 1">{{ formatCriterion(category) }}</td>
                </tr>
                <tr *ngFor="let value of comparisonData.comparisonMatrix[category]; let i = index">
                  <td class="criterion-name">{{ category }}</td>
                  <td *ngFor="let school of selectedSchools; let j = index">
                    {{ comparisonData.comparisonMatrix[category][j] || 'Non sp√©cifi√©' }}
                  </td>
                </tr>
              </ng-container>
            </ng-container>
            </tbody>
          </table>
        </div>

        <!-- Liens vers les √©coles -->
        <div class="school-links">
          <h3>Voir plus de d√©tails</h3>
          <div class="links-grid">
            <a
              *ngFor="let school of selectedSchools"
              [routerLink]="['/schools', school.id]"
              class="school-link"
            >
              Voir la page de {{ school.name }}
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<app-footer></app-footer>
